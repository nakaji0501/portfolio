<template>
    <div class="questionForm">
        <div class="form_wrapper"
        v-show="isLogin">

            <div class="loader">
                <Loader
                v-show="posting"
                >
                    <template slot="loadingText">
                        質問を投稿中です。しばらくお待ちください。
                    </template>
                </Loader>
            </div>

            <form class="form"
            @submit.prevent="postQuestion"
            v-show="! posting"
            >

            <div class="postErrors"
            v-if="postErrors">
                <ul
                v-if="postErrors.title"
                >
                <li v-for="msg in postErrors.title"
                :key="msg"
                >
                    {{ msg }}
                </li>
                </ul>
            </div>

            <div class="form_content title">
                <label for="title">タイトル</label>
                <input type="text" id="title" class="form_item"
                v-model="question.title"
                >
            </div>

            <div class="postErrors"
            v-if="postErrors">
                <ul
                v-if="postErrors.message"
                >
                <li v-for="msg in postErrors.message"
                :key="msg"
                >
                    {{ msg }}
                </li>
                </ul>
            </div>

            <div class="form_content message">
                <label for="text">投稿する内容</label>
                <textarea type="text" id="message" class="form_item"
                cols="30" rows="10"
                v-model="question.message"
                ></textarea>
            </div>

                <PostButton />
            </form>
        </div>
    </div>
</template>

<script>
import PostButton from '../components/PostButton'
import Loader from '../components/Loader'

export default {
    components: {
        PostButton,
        Loader,
    },
    data() {
        return {
            question: {
                title: '',
                message: '',
            },
            posting: false,
        }
    },
    computed: {
        isLogin() {
            return this.$store.getters['auth/check']
        },
        questions() {
            return this.$store.state.post.questions
        },
        setPostStatus() {
            return this.$store.state.post.postStatus
        },
        postErrors() {
            return this.$store.state.post.postErrorMessages
        }
    },
    methods: {
        async postQuestion() {
            this.posting = true

            const response = await this.$store.dispatch('post/postQuestion', this.question)
            if (this.setPostStatusl) {
                this.$router.push('/')
            }

            this.posting = false
        },
        clearError() {
            this.$store.commit('post/setPostErrorMessages', null)
        },
    },
    created() {
        this.clearError()
    },
    mounted() {
        if (! this.isLogin) {
            this.$router.push('/login')
        }
    }
}
</script>

<style lang="scss" scoped>
.form label,input {
    display: block;
}
.postErrors {
    color: red;
}
</style>